<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SQL: REGEX_REPLACE | Sean Livelsberger</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="SQL: REGEX_REPLACE" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to manage messy strings when you want quality numeric data." />
<meta property="og:description" content="How to manage messy strings when you want quality numeric data." />
<link rel="canonical" href="https://seanlivelsberger.github.io/sql/2020/03/04/sql-regex-replace.html" />
<meta property="og:url" content="https://seanlivelsberger.github.io/sql/2020/03/04/sql-regex-replace.html" />
<meta property="og:site_name" content="Sean Livelsberger" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-04T00:00:00-06:00" />
<script type="application/ld+json">
{"description":"How to manage messy strings when you want quality numeric data.","@type":"BlogPosting","url":"https://seanlivelsberger.github.io/sql/2020/03/04/sql-regex-replace.html","headline":"SQL: REGEX_REPLACE","dateModified":"2020-03-04T00:00:00-06:00","datePublished":"2020-03-04T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://seanlivelsberger.github.io/sql/2020/03/04/sql-regex-replace.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://seanlivelsberger.github.io/feed.xml" title="Sean Livelsberger" />

  <script>
  function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
  }
  window.onload = wrap_img;
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
      // add link icon to anchor tags
      var elem = document.querySelectorAll(".anchor-link")
      elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
      // remove paragraph tags in rendered toc (happens from notebooks)
      var toctags = document.querySelectorAll(".toc-entry")
      toctags.forEach(e => (e.firstElementChild.innerText = e.firstElementChild.innerText.replace('¶', '')))
    });
  </script>
</head><body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Sean Livelsberger</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/expertise/">Expertise</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SQL: REGEX_REPLACE</h1><p class="page-description">How to manage messy strings when you want quality numeric data.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-04T00:00:00-06:00" itemprop="datePublished">
        Mar 4, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#sql">sql</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
</ul><p>Imagine that you are working with a particularly messy dataset. In this scenario you have a field available to you that is of a string-based data type. However, the data in this field is supposed to represent some set of numeric values (e.g. price, quantity, etc.).</p>

<p>This is a frequently encountered scenario when working with messy data. Assuming the values of this field are “clean,” one can simply coerce the field into the desired numeric data type with a statement similar to that of the one shown below:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">messy_numeric_field</span><span class="p">::</span><span class="nb">DOUBLE</span> <span class="k">as</span> <span class="n">actual_numeric_field</span>
   <span class="k">FROM</span>
   <span class="n">data_table</span>
</code></pre></div></div>

<p>Now, if the values are not “clean,” then if one wants to create a numeric field, one must creatively clean the data.</p>

<p>There are many ways in which the data can be unclean. For this post, I want to focus on the scenario where the alleged numeric field somehow has come to possess non-numeric characters amidst the numeric characters. Below are some examples of this case.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">6</span><span class="p">,</span><span class="mi">000</span><span class="p">.</span><span class="mi">00</span>
<span class="err">$</span><span class="mi">500</span>
<span class="p">[</span><span class="mi">33</span><span class="p">]</span>
</code></pre></div></div>

<p>If one were to try to coerce these values to a numeric format, the SQL database would throw an error. In the first example, the SQL engine will not understand how to interpret the comma. In the second example, the SQL engine will clearly not know how to interpret the currency denomination. Lastly, in the third example, the SQL engine will not know what to do with the brackets.
One strategy for managing these uninterpretable characters would be to do a form of replacement or series of replacements using the REPLACE function. Below, I have drawn up the usage of this function that would create a field that could be successfully coerced as a numeric data type.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="k">REPLACE</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="n">messy_numeric_field</span><span class="p">,</span><span class="s1">','</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'usd'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">'['</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">']'</span><span class="p">,</span><span class="s1">''</span><span class="p">)::</span><span class="nb">DOUBLE</span> <span class="k">as</span> <span class="n">actual_numeric_field</span>
   <span class="k">FROM</span>
   <span class="n">data_table</span>
</code></pre></div></div>

<p>As one builds this sort of fix, it becomes evident that this solution is not scalable. One will have to constantly manage this query for any new odd characters that appear in the base field.</p>

<p>In order to manage this problem in a scalable manner, one should instead rely on the regular expressions enabled replace function, REGEXP_REPLACE. With regular expressions, one can search for patterns within text as opposed to a specific value or sequence of values. To solve the problem that we are facing, one would want to use the query below.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">REGEXP_REPLACE</span><span class="p">(</span><span class="n">messy_numeric_field</span><span class="p">,</span><span class="s1">'[^0-9.]'</span><span class="p">,</span><span class="s1">''</span><span class="p">)::</span><span class="nb">DOUBLE</span> <span class="k">as</span> <span class="n">actual_numeric_field</span>
   <span class="k">FROM</span>
   <span class="n">data_table</span>
</code></pre></div></div>

<p>This use of the REGEXP_REPLACE function operates by searching for any characters that are not a number or not a period. Once it finds a character that fits that pattern, it replaces it with the empty string, thereby removing any unwanted characters. One can then proceed with the data type coercion with a cleansed field of values.</p>

<p>Based on my past experiences, one additional recommendation would be to add a NULLIF wrapper on the above usage of REGEXP_REPLACE. The addition is featured in the update query below.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="k">NULLIF</span><span class="p">(</span><span class="n">REGEXP_REPLACE</span><span class="p">(</span><span class="n">messy_numeric_field</span><span class="p">,</span><span class="s1">'[^0-9.]'</span><span class="p">,</span><span class="s1">''</span><span class="p">),</span><span class="s1">''</span><span class="p">)::</span><span class="nb">DOUBLE</span> <span class="k">as</span> <span class="n">actual_numeric_field</span>
   <span class="k">FROM</span>
   <span class="n">data_table</span>
</code></pre></div></div>

<p>The usage of NULLIF here adds an extra layer of cleanliness to your data clean up. It is specifically relevant due to the fact that the replace action is insert the empty string. If a messy field value consists exclusively of non-numeric characters (e.g. just a decimal) it would leave an empty string final value after our replacement operation. This is less that ideal for two reasons. For one, depending on the SQL engine, the empty string may actually not convert to a numeric in the coercion operation. More importantly though, the existence of empty string numeric values may not be perceptible if the dataset is sufficiently large. If one then goes to count non-null values under the assumption that values are either legitimate or null, one could potentially come away with an incorrect understanding of their data.</p>

  </div><a class="u-url" href="/sql/2020/03/04/sql-regex-replace.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sean Livelsberger</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sean Livelsberger</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li><a href="https://github.com/seanlivelsberger"><svg class="social svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> </a></li>
  <!----><li><a href="https://instagram.com/sean.livelsberger"><svg class="social svg-icon"><use xlink:href="/assets/minima-social-icons.svg#instagram"></use></svg> </a></li><li><a href="https://www.linkedin.com/in/seanlivelsberger"><svg class="social svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> </a></li><li><a href="https://www.twitter.com/seanlivelsberg"><svg class="social svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> </a></li><!---->
  <!---->
</ul>
</div>

      <div class="footer-col footer-col-3">
        <p> </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
